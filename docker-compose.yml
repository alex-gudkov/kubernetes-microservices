version: '3.8'

services:
    redis:
        container_name: kubernetes_microservices_redis
        image: redis:7
        ports:
            - 6379:6379
        volumes:
            - ./redis_data:/data
        networks:
            - kubernetes_microservices_network
    postgres:
        container_name: kubernetes_microservices_postgres
        image: postgres:14
        ports:
            - 5432:5432
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: root
            POSTGRES_DB: kubernetes_microservices
        volumes:
            - ./pg_data:/var/lib/postgresql
        networks:
            - kubernetes_microservices_network
    rabbitmq:
        container_name: kubernetes_microservices_rabbitmq
        image: rabbitmq:3
        ports:
            - 15672:15672
            - 5672:5672
        networks:
            - kubernetes_microservices_network
    auth:
        container_name: kubernetes_microservices_auth
        env_file:
            - ./apps/auth/.env
        ports:
            - 3001:3001
        depends_on:
            - rabbitmq
            - redis
        build:
            context: ./apps/auth
            dockerfile: Dockerfile
        networks:
            - kubernetes_microservices_network
    users:
        container_name: kubernetes_microservices_users
        env_file:
            - ./apps/users/.env
        ports:
            - 3002:3002
        depends_on:
            - rabbitmq
            - postgres
        build:
            context: ./apps/users
            dockerfile: Dockerfile
        networks:
            - kubernetes_microservices_network
    wallets:
        container_name: kubernetes_microservices_wallets
        env_file:
            - ./apps/wallets/.env
        ports:
            - 3003:3003
        depends_on:
            - rabbitmq
            - postgres
        build:
            context: ./apps/wallets
            dockerfile: Dockerfile
        networks:
            - kubernetes_microservices_network

volumes:
    pg_data:
    redis_data:

networks:
    kubernetes_microservices_network:
        external: true
